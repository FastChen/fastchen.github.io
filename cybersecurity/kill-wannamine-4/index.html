<!doctype html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <title>记一次手动处置挖矿病毒 WannaMine 变种 4.0 版 | FASTCHEN</title>

  
<link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css">

  
<link rel="stylesheet" href="/bootstrap/css/bootstrap-icons.min.css">

  
<link rel="stylesheet" href="/css/style.css">


  <link rel="shortcut icon" href="/favicon.ico">

  <meta name="description" content="一介凡人快辰的个人发牢骚之地。灵工艺的创始人。">
  <meta name="keywords" content="快辰,FastChen,灵工艺,NullCraft,创始人">

  <!-- Apple设备图标 -->
  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo_2022_256.png">
  <!-- Android设备图标 -->
  <link rel="icon" type="image/png" sizes="192x192" href="/images/logo_2022_256.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/images/logo_2022_256.png">

  <!-- Open Graph协议(社交媒体分享) -->
  <meta name="description" content="在工作中遇到的杀毒软件无法完全清理的病毒程序 WannaMine 4.0。">
<meta property="og:type" content="article">
<meta property="og:title" content="记一次手动处置挖矿病毒 WannaMine 变种 4.0 版">
<meta property="og:url" content="https://fastchen.com/cybersecurity/kill-wannamine-4/index.html">
<meta property="og:site_name" content="FASTCHEN">
<meta property="og:description" content="在工作中遇到的杀毒软件无法完全清理的病毒程序 WannaMine 4.0。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://fastchen.com/images/blog/kill-wannamine-4/processhacker_1.png">
<meta property="article:published_time" content="2023-09-20T10:47:00.000Z">
<meta property="article:modified_time" content="2023-09-20T12:45:32.534Z">
<meta property="article:author" content="FastChen">
<meta property="article:tag" content="安全技术">
<meta property="article:tag" content="挖矿病毒">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fastchen.com/images/blog/kill-wannamine-4/processhacker_1.png">
<meta name="generator" content="Hexo 7.3.0"></head>

  <body class="bg-body-tertiary">
    <header class="bg-body p-3 mb-3 border-bottom">
    <div class="container">
      <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
        <a href="/" class="d-flex align-items-center mb-2 mb-lg-0 link-body-emphasis text-decoration-none">
          <img width="32" height="32" src="/images/logo_2022_256.png" />
        </a>
        <ul class="nav nav-underline col-12 col-lg-auto me-lg-auto ms-3 mb-2 justify-content-center mb-md-0">
          
          <li><a href="/" class="nav-link px-2 link-body-emphasis">主页</a></li>
          
          <li><a href="/archives" class="nav-link px-2 link-body-emphasis">归档</a></li>
          
          <li><a href="/categories" class="nav-link px-2 link-body-emphasis">分类</a></li>
          
          <li><a href="/tags" class="nav-link px-2 link-body-emphasis">标签</a></li>
          
          <li><a href="/about" class="nav-link px-2 link-body-emphasis">关于我</a></li>
          
        </ul>
      </div>
    </div>
  </header>

    
    <div class="container my-5">
      <div class="post">
    <h1 class="post-title fw-semibold">
    
        <div class="text-center">
            记一次手动处置挖矿病毒 WannaMine 变种 4.0 版
        </div>
    
</h1>

    
        <div class="text-center">
            
<div class="mb-4 text-muted author-info">
    
        <span title="2023-09-20T10:47:00.000Z"><i class="bi bi-calendar2 me-2" title="发布于 2023-09-20"></i>发布于 2023-09-20</span>
    
    
        <span class="ms-3" title="2023-09-20T12:45:32.534Z"><i class="bi bi-calendar2-plus me-2" title="更新于 2023-09-20"></i>更新于 2023-09-20</span>
    
    
    
        
            <span class="ms-3">
                <i class="bi bi-folder me-2"></i><a class="category-link" href="/categories/cybersecurity/">网络安全</a>
            </span>
        
    
</div>
        </div>
    

    
        <p>在工作中遇到的杀毒软件无法完全清理的病毒程序 WannaMine 4.0。</p>
<span id="more"></span>

<blockquote>
<p>本文信息已脱敏，将主要以文字格式进行书写。</p>
</blockquote>
<h1 id="了解-WannaMine-4-0"><a href="#了解-WannaMine-4-0" class="headerlink" title="了解 WannaMine 4.0"></a>了解 WannaMine 4.0</h1><h2 id="WannaMine-4-0-变种信息"><a href="#WannaMine-4-0-变种信息" class="headerlink" title="WannaMine 4.0 变种信息"></a>WannaMine 4.0 变种信息</h2><blockquote>
<p>所谓了解你的敌人才能打败它，知彼知己者，百战不殆。<br> ——《谋攻篇》 </p>
</blockquote>
<h3 id="发作特征"><a href="#发作特征" class="headerlink" title="发作特征"></a>发作特征</h3><p>WannaMine，病毒如其名，一款挖矿病毒，特征为高占用系统资源，导致系统正常运作出现异常问题等。</p>
<h3 id="传染途径"><a href="#传染途径" class="headerlink" title="传染途径"></a>传染途径</h3><p>当局域网内拥有一台被入侵宿主主机后，将通过微软关键漏洞 —— 永恒之蓝(MS17-010) 入侵局域网内其它主机，实现交叉感染并且再次利用漏洞模块对局域网内进行定时发起大量的 SMB 扫描(445端口)进行爆破入侵，并且横向扩散。</p>
<p>具体传播流程如下：<br>当主机存在 MS17-010 漏洞时并且防火墙开放了 445 端口(用于SMB网络共享协议，如共享文件夹。)的 Windows 系列系统。</p>
<blockquote>
<p>有关 永恒之蓝(MS17-010) 具体信息可访问：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/security-updates/securitybulletins/2017/ms17-010">Microsoft 安全公告 MS17-010 - 关键</a></p>
</blockquote>
<h3 id="如何判断是否存在-MS17-010-漏洞？"><a href="#如何判断是否存在-MS17-010-漏洞？" class="headerlink" title="如何判断是否存在 MS17-010 漏洞？"></a>如何判断是否存在 MS17-010 漏洞？</h3><p>可以通过查看已安装补丁来确认是否存在漏洞。<a target="_blank" rel="noopener" href="https://support.microsoft.com/zh-cn/topic/%E5%A6%82%E4%BD%95%E9%AA%8C%E8%AF%81%E6%98%AF%E5%90%A6%E5%B7%B2%E5%AE%89%E8%A3%85-ms17-010-f55d3f13-7a9c-688c-260b-477d0ec9f2c8">如何验证是否已安装 MS17-010</a></p>
<h2 id="WannaMine-4-0-攻击流程"><a href="#WannaMine-4-0-攻击流程" class="headerlink" title="WannaMine 4.0 攻击流程"></a>WannaMine 4.0 攻击流程</h2><h3 id="攻击步骤一-创建主服务"><a href="#攻击步骤一-创建主服务" class="headerlink" title="攻击步骤一 - 创建主服务"></a>攻击步骤一 - 创建主服务</h3><p>病毒进入主机后，将通过三串字符串进行随机拼接名称来躲避免杀。</p>
<p>三组字符串如下：</p>
<ol>
<li>Windows | Microsoft | Network | Remote | Function | Secure | Application</li>
<li>Update | Time | NetBIOS | RPC | Protocol | SSDP | UPnP</li>
<li>Service | Host | Client | Event | Manager | Helper | System</li>
</ol>
<p>病毒会按照顺序从每个字符串组中随机抽取一个进行拼接。例如：<code>NetworkSSDPHost</code>，我们将此模块称为 <strong>主服务</strong> 模块。</p>
<p>当随机字符串生成后，将会以随机出来的名字注册服务也就是 <code>services.msc</code>，并且会在 <code>C:\Windows\System32\</code> 路径下创建一个与服务同名的 <code>.dll</code> 文件。</p>
<p>此动态库由系统进程 <code>svchost.exe</code> 加载，确保每次都能开机启动，然后调用 <code>spoolsv.exe</code> 并同时加载 <code>dllhostex.exe</code> 挖矿脚本。</p>
<h3 id="攻击步骤二-收集并攻击-MS17-010-漏洞主机"><a href="#攻击步骤二-收集并攻击-MS17-010-漏洞主机" class="headerlink" title="攻击步骤二 - 收集并攻击 MS17-010 漏洞主机"></a>攻击步骤二 - 收集并攻击 MS17-010 漏洞主机</h3><p>通过 <code>spoolsv.exe</code> 扫描 445 漏洞，确定可以攻击的主机，然后会在 <code>C:\Windows\NetworkDistribution\</code> 目录下释放病毒的漏洞攻击程序，同时启动 <code>svchost.exe</code> 和 <code>spoolsv.exe</code> (均为伪装成正常文件名的病毒脚本)。</p>
<p>此时 <code>svchost.exe</code> 会对收集到可进行攻击的目标主机执行 永恒之蓝(MS17-010) 漏洞进行攻击，成功后 <code>spoolsv.exe</code> 会对主机安装后门，加载 payload 文件 (x86.dll &#x2F; x64.dll)</p>
<h3 id="攻击步骤三-感染主机"><a href="#攻击步骤三-感染主机" class="headerlink" title="攻击步骤三 - 感染主机"></a>攻击步骤三 - 感染主机</h3><p>当 payload (x86.dll&#x2F;x64.dll) 执行后，负责将 <code>rdpkax.xsl</code> (病毒包似乎也是随机名称与后缀，其组件包含 永恒之蓝(MS17-010) 漏洞攻击工具集) 从本地复制到目标 IP 主机，然后重复 <strong>攻击步骤一 - 创建主服务</strong> 、<strong>攻击步骤二 - 收集并攻击 MS17-010 漏洞主机</strong> 部分。</p>
<h1 id="处置-WannaMine-4-0"><a href="#处置-WannaMine-4-0" class="headerlink" title="处置 WannaMine 4.0"></a>处置 WannaMine 4.0</h1><h2 id="操作前提示"><a href="#操作前提示" class="headerlink" title="操作前提示"></a>操作前提示</h2><p>以下操作建议在将主机彻底隔离断网的情况下进行，否则可能出现病毒复活再生。<br>不推荐在病毒活跃情况下使用 U盘、移动硬盘 等外置存储工具传输文件，以防再次交叉感染，可以先断网操作删除病毒后，再通过外置存储工具传输补丁文件。</p>
<h2 id="使用工具"><a href="#使用工具" class="headerlink" title="使用工具"></a>使用工具</h2><p>不使用工具也可以对病毒进行移除，但是使用工具可以更方便的处理一些需要手动确认的信息。</p>
<ul>
<li>增强工具：<a target="_blank" rel="noopener" href="https://processhacker.sourceforge.io/">Process Hacker - 一款免费、功能强大的多功能工具，可帮助您监控系统资源、调试软件和检测恶意软件。</a><ul>
<li>主要拿来查找病毒进程并且结束，移除病毒主服务模块和文件，同时也能查看病毒是否通过漏洞进行攻击(Network功能)。</li>
</ul>
</li>
<li>漏洞补丁包：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/security-updates/securitybulletins/2017/ms17-010">可以通过微软官方网站下载对应系统的补丁包 Microsoft 安全公告 MS17-010 - 关键</a><ul>
<li>注意区分操作系统，不同系统不同位数需要使用对应的补丁包才能有效按照并且防御病毒。</li>
</ul>
</li>
</ul>
<h2 id="开始处置"><a href="#开始处置" class="headerlink" title="开始处置"></a>开始处置</h2><h3 id="确定并移除病毒主模块服务"><a href="#确定并移除病毒主模块服务" class="headerlink" title="确定并移除病毒主模块服务"></a>确定并移除病毒主模块服务</h3><p><strong>快速定位病毒主服务方法 (仅适用于中文系统及服务项不多的情况)</strong><br>通过 服务 <code>services.msc</code> 来查找到病毒主服务模块，因为使用中文系统，里的 服务名称 或 服务描述 大部分都是中文的，所以可以通过以下描述内容尝试快速筛查英文描述并定位病毒主服务名称</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 描述内容：</span><br><span class="line">Enables a common interface and object model for the 与主服务名称一致的字符串 Helper to ....</span><br><span class="line"></span><br><span class="line"># 例如：</span><br><span class="line">Enables a common interface and object model for the NetworkSSDPHost Helper to ....</span><br></pre></td></tr></table></figure>
<p>如果无法通过服务定位到可以使用下面的方法：</p>
<p><strong>Process Hacker 软件定位病毒主服务方法</strong><br>在 Process Hacker 软件右上角输入框中搜索 <code>dllhostex.exe</code> 并且切换到 Services 选项卡，如病毒正在运作，此时会显示与此进程相关联的服务。<br><strong>此图仅演示</strong><br><img src="/images/blog/kill-wannamine-4/processhacker_1.png" alt="processhacker_1.png"></p>
<p>确定好主服务名称并<strong>牢记</strong>后，将服务停止并删除服务，删除服务后再前往 <code>C:\Windows\System32\</code> 目录下找到与主服务名称一致的 <code>.dll</code> 文件一并删除。</p>
<p>如果遇到主服务删除不掉问题，则需要找到 <code>dllhostex.exe</code> 挖矿病毒进程并结束，然后再次尝试停止并删除服务与服务对应的dll文件。</p>
<h3 id="移除病毒挖矿脚本程序"><a href="#移除病毒挖矿脚本程序" class="headerlink" title="移除病毒挖矿脚本程序"></a>移除病毒挖矿脚本程序</h3><p>进入目录 <code>C:\Windows\System32\</code> 下找到 <code>dllhostex.exe</code> 挖矿脚本，进行删除。</p>
<h3 id="移除病毒释放漏洞利用模块"><a href="#移除病毒释放漏洞利用模块" class="headerlink" title="移除病毒释放漏洞利用模块"></a>移除病毒释放漏洞利用模块</h3><p>进入目录 <code>C:\Windows\</code> 下找到 <code>NetworkDistribution</code> 文件夹，进行删除。</p>
<h2 id="安装补丁"><a href="#安装补丁" class="headerlink" title="安装补丁"></a>安装补丁</h2><p>通过微软官方提供的网站下载漏洞补丁包：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/security-updates/securitybulletins/2017/ms17-010">可以通过微软官方网站下载对应系统的补丁包 Microsoft 安全公告 MS17-010 - 关键</a></p>
<p>然后进行安装即可防御 永恒之蓝(MS17-010) 漏洞的攻击入侵。</p>
<h2 id="测试病毒是否复活"><a href="#测试病毒是否复活" class="headerlink" title="测试病毒是否复活"></a>测试病毒是否复活</h2><p>确定补丁安装完毕后，将主机重启并连入局域网内，等待 10-30 分钟后查看目录 <code>C:\Windows\</code> 下是否存在 <code>NetworkDistribution</code> 文件夹。</p>
<p>如还存在，应该检查补丁是否安装正确，和是否遗漏删除了病毒的文件。</p>
<p>如不存在则代表成功防御并解决病毒，恭喜你。</p>
<p><strong>大功告成。</strong></p>
<p>文章参考：<br><a target="_blank" rel="noopener" href="https://bbs.sangfor.com.cn/forum.php?mod=viewthread&tid=152179">深信服社区 - WannaMine4.0挖矿病毒处置</a><br><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/terminal/198891.html">WannaMine升级到V4.0版本，警惕中招！</a></p>

      
    
    

    
        
            <a href="/tags/%E5%AE%89%E5%85%A8%E6%8A%80%E6%9C%AF/"><span class="tag-item" data-tag="安全技术">#安全技术</span></a>
        
            <a href="/tags/%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/"><span class="tag-item" data-tag="挖矿病毒">#挖矿病毒</span></a>
        
    

</div>
    </div>

    
<!-- 返回顶部 -->
<a href="#" id="back-to-top" class="btn btn-secondary back-to-top" title="返回顶部"><i class="bi bi-arrow-up" style="width: auto;"></i></a>

<script src="/js/utils/back-to-top.js"></script>


    <footer class="border-top bg-body">
  <div class="container">
    
    <div class="d-flex flex-column flex-sm-row justify-content-between py-3 mt-3">
      <div>
        <a href="/" class="link-body-emphasis text-decoration-none">
          <img width="32" height="32" src="/images/logo_2022_256.png" />
        </a>
        <span class="ms-2">
          © 2025 <a href="https://fastchen.com">FASTCHEN</a> All Rights Reserved. 由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> &amp; <a href="https://github.com/FastChen/hexo-theme-sujian" rel="noopener" target="_blank">SuJian</a> 强力驱动
        </span>
      </div>

      <ul class="list-unstyled d-flex d-grid gap-3">
          
            
            
            
            <li>
                <a class="link-body-emphasis" target="_blank" rel="noopener" href="https://github.com/fastchen">
                <i class="bi bi-github" style="font-size: 24px;"></i>
              </a>
            </li>
          
      </ul>
    </div>
  </div>
</footer>




<script src="/bootstrap/js/bootstrap.min.js"></script>



<script src="/js/utils/tag-color.js"></script>

<script>
// 页面加载后设置标签颜色
document.addEventListener('DOMContentLoaded', function() {
    TagColor.applyRandomColorsToAll('.tag-item');
});
</script>
  </body>
  
</html>